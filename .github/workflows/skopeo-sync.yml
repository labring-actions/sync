name: skopeo-sync
on:
  push:
    branches: [ main ]
    paths:
      - "skopeo/src.yaml"
      - ".github/workflows/skopeo-sync.yml"
  pull_request:
    branches: [ main ]
    paths:
      - "skopeo/src.yaml"
      - ".github/workflows/skopeo-sync.yml"
  schedule:
    - cron: '0 16 * * *'

env:
  USERNAME: ${{ secrets.SEALOS_REGISTRY_USER }}
  PASSWORD: ${{ secrets.SEALOS_REGISTRY_PASSWORD }}

jobs:
  image-sync:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: check podman
        run: |
          sudo podman version

      - name: sync images
        run: |
          sudo podman run -it --rm -v ${PWD}:/workspace -w /workspace quay.io/skopeo/stable:latest \
          sync --src yaml --dest docker skopeo/src.yaml hub.sealos.cn/labring \
          --dest-username $USERNAME --dest-password $PASSWORD \
          --keep-going --retry-times 2